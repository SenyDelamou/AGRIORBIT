generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  ADVISOR
  FARMER
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum AnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model User {
  id                  String                @id @default(cuid())
  email               String                @unique
  passwordHash        String?
  provider            AuthProvider          @default(LOCAL)
  googleSub           String?               @unique
  name                String
  role                UserRole              @default(FARMER)
  language            String                @default("fr")
  localLanguages      String[]              @default([])
  organization        String?
  picture             String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  fields              Field[]
  notifications       Notification[]
  testimonials        Testimonial[]
  demoRequests        DemoRequest[]
}

model RefreshToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  expiresAt  DateTime
  revoked    Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  code      String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([code, userId])
}

model Field {
  id            String     @id @default(cuid())
  name          String
  ownerId       String
  owner         User       @relation(fields: [ownerId], references: [id])
  latitude      Float
  longitude     Float
  areaHectares  Float?
  cropType      String?
  geoJsonPath   String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  analyses      Analysis[]
}

model Analysis {
  id              String         @id @default(cuid())
  fieldId         String
  field           Field          @relation(fields: [fieldId], references: [id])
  ndvi            Float?
  ndwi            Float?
  healthScore     Int?
  status          AnalysisStatus @default(PENDING)
  summary         String?
  recommendations Json?
  dataSources     String[]?
  capturedAt      DateTime?      @default(now())
  createdAt       DateTime       @default(now())
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  type      String
  title     String
  message   String
  status    NotificationStatus @default(UNREAD)
  metadata  Json?
  readAt    DateTime?
  createdAt DateTime           @default(now())
}

model AdvisoryProgram {
  id        String   @id @default(cuid())
  name      String   @unique
  detail    String
  published Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Testimonial {
  id        String   @id @default(cuid())
  name      String
  role      String?
  quote     String
  metric    String?
  status    String   @default("NEW")
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model DemoRequest {
  id        String   @id @default(cuid())
  email     String
  name      String?
  message   String?
  status    String   @default("NEW")
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}
